# Implementation Notes

## Architecture Decisions

### 1. Terraform Plugin Framework vs SDK

**Decision**: Use Terraform Plugin Framework (v1.4+)

**Rationale**:
- Modern approach recommended by HashiCorp
- Type-safe schema definitions
- Better error handling and diagnostics
- Built-in validation framework
- Better testing support
- Future-proof (SDK v2 is in maintenance mode)

### 2. API Client Design

**Decision**: Custom HTTP client with context support

**Structure**:
```go
type Client struct {
    BaseURL    string
    APIKey     string
    HTTPClient *http.Client
}
```

**Rationale**:
- Full control over request/response handling
- Easy to add middleware (retry, rate limiting)
- Context cancellation support
- No external SDK dependency
- Portkey doesn't provide official Go SDK for Admin API

### 3. Resource State Management

**Decision**: Use computed timestamps and IDs

**Pattern**:
```go
"id": schema.StringAttribute{
    Computed: true,
    PlanModifiers: []planmodifier.String{
        stringplanmodifier.UseStateForUnknown(),
    },
}
```

**Rationale**:
- IDs generated by API
- Timestamps managed by backend
- Prevents unnecessary updates
- Maintains consistency with API state

## API Integration Details

### Authentication

**Header**: `x-portkey-api-key`

**Example**:
```go
req.Header.Set("x-portkey-api-key", c.APIKey)
```

This differs from the Inference API which uses `Authorization: Bearer` header.

### Response Formats

Most list endpoints return:
```json
{
  "data": [...],
  "object": "list",
  "total": 10
}
```

Single resource endpoints return the resource directly.

### Error Handling

API errors follow this pattern:
- 401: Authentication failed
- 403: Insufficient permissions
- 404: Resource not found
- 422: Validation error
- 500: Server error

## Known Limitations

### 1. User Invite Updates

**Limitation**: User invites cannot be updated via API

**Implementation**: Update() method returns error

**Workaround**: Delete and recreate invitation

### 2. Workspace Deletion

**Limitation**: Cannot delete workspace with resources

**Implementation**: Returns error from API

**Workaround**: Remove all resources first (virtual keys, configs, members)

### 3. Role Enumeration

**Current**: Roles are strings without validation

**Issue**: API doesn't provide role enumeration endpoint

**Future**: Add validation once roles are documented

## Testing Considerations

### Acceptance Tests

**Requirements**:
- Valid Portkey Admin API key
- Organization with Owner/Admin role
- Clean test environment

**Cleanup**:
- Delete resources in reverse dependency order
- Handle "resource not found" gracefully
- Use unique names with timestamps

**Example Pattern**:
```go
func testAccWorkspace(t *testing.T) {
    resource.Test(t, resource.TestCase{
        PreCheck: func() { testAccPreCheck(t) },
        ProtoV6ProviderFactories: testAccProtoV6ProviderFactories,
        Steps: []resource.TestStep{
            {
                Config: testAccWorkspaceConfig("test-workspace"),
                Check: resource.ComposeAggregateTestCheckFunc(
                    resource.TestCheckResourceAttr("portkey_workspace.test", "name", "test-workspace"),
                ),
            },
        },
    })
}
```

### Mocking Strategy

For unit tests without API access:

```go
type mockClient struct {
    createWorkspaceFunc func(ctx context.Context, req CreateWorkspaceRequest) (*Workspace, error)
}

func (m *mockClient) CreateWorkspace(ctx context.Context, req CreateWorkspaceRequest) (*Workspace, error) {
    return m.createWorkspaceFunc(ctx, req)
}
```

## Performance Considerations

### Rate Limiting

**Current**: No built-in rate limiting

**Recommendation**: 
- Add exponential backoff for 429 responses
- Implement request throttling
- Use Terraform's `-parallelism` flag

**Future Implementation**:
```go
func (c *Client) doRequestWithRetry(ctx context.Context, method, path string, body interface{}) ([]byte, error) {
    maxRetries := 3
    backoff := time.Second
    
    for i := 0; i < maxRetries; i++ {
        resp, err := c.doRequest(ctx, method, path, body)
        if err == nil {
            return resp, nil
        }
        
        if isRateLimitError(err) && i < maxRetries-1 {
            time.Sleep(backoff)
            backoff *= 2
            continue
        }
        return nil, err
    }
}
```

### Caching

**Current**: No caching

**Potential**: Cache GET requests for data sources

**Consideration**: Must handle cache invalidation properly

## Security Considerations

### API Key Storage

**Current**: Plain text in memory

**Security**:
- Marked as sensitive in schema
- Not logged in debug output
- Cleared on provider destruction

### State File Security

**Contains**:
- Workspace IDs (non-sensitive)
- User emails (potentially sensitive)
- User IDs (non-sensitive)
- Timestamps (non-sensitive)

**Recommendation**:
- Use encrypted remote state
- Restrict state file access
- Enable state locking

## API Mapping

### Portkey Admin API → Terraform Resources

| API Endpoint | Terraform Resource | Operations |
|-------------|-------------------|------------|
| /workspaces | portkey_workspace | CRUD |
| /workspaces/{id}/members | portkey_workspace_member | CRUD |
| /users/invites | portkey_user_invite | Create, Read, Delete |
| /users | N/A (data source only) | Read |

### Future Resources

| API Endpoint | Future Resource | Priority |
|-------------|----------------|----------|
| /virtual-keys | portkey_virtual_key | High |
| /configs | portkey_config | High |
| /api-keys | portkey_api_key | Medium |

## Code Organization

### Package Structure

```
internal/
├── client/          # API client and types
│   └── client.go    # HTTP client, request methods, API types
└── provider/        # Terraform provider implementation
    ├── provider.go  # Provider definition
    ├── *_resource.go    # Resource implementations
    └── *_data_source.go # Data source implementations
```

### Naming Conventions

- **Resources**: `{resource_name}_resource.go`
- **Data Sources**: `{resource_name}_data_source.go`
- **Types**: `{resource_name}Model` for Terraform schema models
- **API Types**: Capitalized names in client package

### Error Messages

**Pattern**: Provide context and actionable guidance

**Good**:
```
Error: Unable to Create Portkey Workspace
Could not create workspace, unexpected error: API request failed with status 403

This usually means your API key lacks the required permissions. Ensure your API key has the 'workspaces.create' scope.
```

**Bad**:
```
Error: 403
```

## Debugging Tips

### Enable Verbose Logging

```bash
export TF_LOG=DEBUG
export TF_LOG_PATH=./terraform.log
terraform apply
```

### Check API Requests

Add logging in client.go:
```go
log.Printf("[DEBUG] Making request: %s %s", method, url)
log.Printf("[DEBUG] Request body: %s", string(jsonBody))
```

### State Inspection

```bash
# Show current state
terraform show

# Show specific resource
terraform state show portkey_workspace.example

# List all resources
terraform state list
```

### Common Issues

**Issue**: "Provider not found"
**Solution**: Run `terraform init`

**Issue**: "API key required"
**Solution**: Set `PORTKEY_API_KEY` environment variable

**Issue**: "Workspace still has resources"
**Solution**: Remove all workspace members, virtual keys, and configs first

## Future Enhancements

### 1. Virtual Keys Resource

**Priority**: High

**Implementation Plan**:
- Add client methods for virtual key CRUD
- Create `portkey_virtual_key` resource
- Support provider types (openai, anthropic, etc.)
- Handle API key encryption/decryption

### 2. Configs Resource

**Priority**: High

**Implementation Plan**:
- Parse config JSON schema
- Create `portkey_config` resource
- Support strategy modes (single, loadbalance, fallback)
- Validate config structure

### 3. Retry Logic

**Priority**: Medium

**Implementation**:
```go
type RetryConfig struct {
    MaxRetries int
    BaseDelay  time.Duration
    MaxDelay   time.Duration
}
```

### 4. Batch Operations

**Priority**: Low

**Use Case**: Create multiple resources efficiently

**Implementation**: Custom resource for bulk operations

## Version Compatibility

### Terraform Version

**Minimum**: 1.0
**Tested**: 1.0, 1.1, 1.2, 1.3, 1.4, 1.5

### Go Version

**Minimum**: 1.21
**Recommended**: 1.21+

### Portkey API

**Version**: v1
**Base URL**: https://api.portkey.ai/v1

## Contributing Guidelines

### Code Style

- Follow Go best practices
- Run `go fmt` before committing
- Use meaningful variable names
- Add comments for complex logic

### Testing Requirements

- Unit tests for client methods
- Resource tests for CRUD operations
- Data source tests for queries
- Import tests for all resources

### Documentation

- Update README for new features
- Add examples for new resources
- Document breaking changes
- Update CHANGELOG

### Pull Request Process

1. Create feature branch
2. Implement changes with tests
3. Update documentation
4. Run `make fmt` and `make lint`
5. Submit PR with clear description

## References

- [Terraform Plugin Framework](https://developer.hashicorp.com/terraform/plugin/framework)
- [Portkey Admin API](https://portkey.ai/docs/api-reference/admin-api/introduction)
- [Go HTTP Client](https://pkg.go.dev/net/http)
- [Terraform Provider Best Practices](https://developer.hashicorp.com/terraform/plugin/best-practices)
